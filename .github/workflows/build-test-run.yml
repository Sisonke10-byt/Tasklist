name: CI - Build, Test & Run

on:
  push:
    branches: [ dev ]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: tasklist-app
  POSTGRES_USER: taskuser
  POSTGRES_PASSWORD: taskpass
  POSTGRES_DB: taskdb

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: docker.io
      IMAGE_NAME: tasklist-app
      POSTGRES_USER: taskuser
      POSTGRES_PASSWORD: taskpass
      POSTGRES_DB: taskdb

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 21

    - name: Build with Maven
      run: mvn clean package -DskipTests

    - name: Create Docker network
      run: |
        docker network create tasklist-net || true

    - name: Start Postgres
      run: |
        docker run -d \
          --name tasklist-db \
          --network tasklist-net \
          -e POSTGRES_USER=$POSTGRES_USER \
          -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
          -e POSTGRES_DB=$POSTGRES_DB \
          -p 5432:5432 \
          postgres:17.6

    - name: Wait for Postgres
      run: |
        for i in {1..20}; do
          docker exec tasklist-db pg_isready -U $POSTGRES_USER && break
          echo "Waiting for Postgres..."
          sleep 3
        done

    - name: Build Spring Boot app image
      run: docker build -t $IMAGE_NAME .

    - name: Start Spring Boot app
      run: |
        docker run -d \
          --name tasklist-app \
          --network tasklist-net \
          -p 8080:8080 \
          -e SPRING_DATASOURCE_URL=jdbc:postgresql://tasklist-db:5432/$POSTGRES_DB \
          -e SPRING_DATASOURCE_USERNAME=$POSTGRES_USER \
          -e SPRING_DATASOURCE_PASSWORD=$POSTGRES_PASSWORD \
          $IMAGE_NAME

    - name: Wait for app
      run: |
        for i in {1..20}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/tasks || echo "000")
          if [[ "$STATUS" == "200" ]]; then
            echo "App is up!"
            break
          fi
          echo "Waiting for app... (status $STATUS)"
          sleep 5
        done

    - name: Smoke test
      run: |
        echo "Testing endpoint..."
        curl -f http://localhost:8080/api/tasks || (docker logs tasklist-app && exit 1)
